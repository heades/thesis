In Chapter~\ref{chap:freedom_of_speech} we defined the Freedom of
Speech language in its entirety.  We now introduce its analysis.  The
main results consist of logical consistency of the logical fragment
and type preservation.  The former is shown by proving weak
normalization of the logical fragment -- the reader may wish to recall
the definition of weak normalization; see
Definition~\ref{def:weak_norm} of
Chapter~\ref{chap:metatheory_of_programming_languages}.  The remainder
of this chapter proceeds by first introducing some basic lemmas to
which the main results will depend.  Then we prove type preservation,
and following this we will prove weak normalization.

\section{Basic Results}
\label{sec:basic_results}
The main results depend on several auxiliary results, and we present
each of them in this section. The first two basic results are
weakening and substitution for typing.  The latter states that if we
know a term $[[e]]$ is well typed in an environment with a free
variable $[[x]]$, and given an expression $[[a]]$ with the same type
as the free variable, then $[[ [a/x]e]]$ has the same type as $[[e]]$.
This is an important result for type preservation, because we want to
ensure that for any $[[(\x.e) v]]$ that has type $[[e']]$, its
contractum $[[ [v/x]e]]$ has type $[[e']]$.

\begin{lemma}[Weakening]
  \label{lemma:FS-weakening}
  If $[[G |- e : e' th]]$, then $[[G, G' |- e : e' th]]$.
\end{lemma}
\begin{proof}
  This holds by straightforward induction on the form of the assumed
  typing derivation.
\end{proof}

\begin{lemma}[Substitution for Typing]
  \label{lemma:substitution}
  If $\Gamma,x:^\theta e_1,\Gamma' \tvdash{\theta'} e:e_2$ and 
  $\Gamma \tvdash{\theta} v:e_1$, 
  then $\Gamma,[v/x]\Gamma' \tvdash{\theta'} [v/x]e:[v/x]e_2$.
\end{lemma}
\begin{proof}
  This is a proof by induction on the form of the assumed typing
  derivation. We only give the non-trivial cases.  All other cases are
  either similar to the cases given here or are trivial.
  \begin{itemize}
  \item[Case.]\ \\
    \begin{center}
      \begin{math}
        $$\mprset{flushleft}
        \inferrule* [right=K\_Pi] {
          \Gamma,x:^\theta e_1,\Gamma' \tvdash{\theta''} e'_1:[[Type]]
          \\\\
          \Gamma,x:^\theta e_1,\Gamma',y:^{\theta''} e'_1 \tvdash{\theta'} e'_2:[[Type]]
        }{\Gamma,x:^\theta e_1,\Gamma' \tvdash{\theta'} \arrowT{y}{\theta''}{e'_1}{\epsilon}{e'_2}:[[Type]]}
      \end{math}
    \end{center}
    By the induction hypothesis, 
    $\Gamma,[v/x]\Gamma' \tvdash{\theta''} [v/x]e'_1:[[Type]]$ and
    $\Gamma,[v/x]\Gamma',y:^{\theta''} [v/x]e'_1 \tvdash{\theta'} [v/x]e'_2:[[Type]]$.  Now we can
    apply $\FSdrulename{K\_Pi}$ to obtain, 
    $\Gamma,[v/x]\Gamma' \tvdash{\theta'} \arrowT{y}{\theta''}{[v/x]e'_1}{\epsilon}{[v/x]e'_2}:[[Type]]$,
    which is equivalent to
    $\Gamma,[v/x]\Gamma' \tvdash{\theta'} [v/x](\arrowT{y}{\theta''}{e'_1}{\epsilon}{e'_2}):[[Type]]$.
    
    \item[Case.]\ \\
      \begin{center}
        \begin{math}
          $$\mprset{flushleft}
          \inferrule* [right=K\_Eq] {
            \Gamma,x:^\theta e_1,\Gamma' \tvdash{\theta_1} e':e'_1
            \\\\
            \Gamma,x:^\theta e_1,\Gamma' \tvdash{\theta_2} e'':e'_2
          }{\Gamma,x:^\theta e_1,\Gamma' \tvdash{L} e' = e'':[[Type]]}
        \end{math}
      \end{center}
      By the induction hypothesis we know 
      $\Gamma,[v/x]\Gamma' \tvdash{\theta_1} [v/x]e':[v/x]e'_1$ and\\
      $\Gamma,[v/x]\Gamma' \tvdash{\theta_2} [v/x]e'':[v/x]e'_2$.  We can now apply 
      $\FSdrulename{K\_Eq}$ to obtain $\Gamma,[v/x]\Gamma' \tvdash{L} [v/x]e' = [v/x]e'':[[Type]]$,
      which is equivalent to $\Gamma,[v/x]\Gamma' \tvdash{L} [v/x](e' = e''):[[Type]]$.

  \item[Case.]\ \\
     \begin{center}
       \begin{math}
         $$\mprset{flushleft}
         \inferrule* [right=\FSdrulename{Var}]{
           \Gamma,x:^\theta e_1,\Gamma' \tvdash{\theta'} e'_1:[[Type]]
           \\\\
           y:^{\theta'} e'_1 \in (\Gamma,x:^\theta e_1,\Gamma')
         }{\Gamma,x:^\theta e_1,\Gamma' \tvdash{\theta'} y:^{\theta'} e'_1}
       \end{math}
     \end{center}
     If $[[x]]$ is distinct from $[[y]]$, then this case follows by first applying the
     induction hypothesis to $\Gamma,x:^\theta e_1,\Gamma' \tvdash{\theta'} e'_1:[[Type]]$
     and then reapplying the $\FSdrulename{Var}$ rule.  Now suppose $[[x == y]]$.  Then the
     previous typing assumption is equivalent to the following:
     \begin{center}
       \begin{math}
         $$\mprset{flushleft}
         \inferrule* [right=\FSdrulename{Var}]{
           \Gamma,x:^\theta e_1,\Gamma' \tvdash{\theta} e_1:[[Type]]
           \\\\
           x:^{\theta} e_1 \in (\Gamma,x:^\theta e_1,\Gamma')
         }{\Gamma,x:^\theta e_1,\Gamma' \tvdash{\theta} x:^{\theta} e_1}
       \end{math}
     \end{center}
     It suffices to show that $[[G, [v/x]G' |- v : e1 th]]$ is
     derivable.  We know by assumption that $[[G |- v : e1 th]]$ is
     derivable, but by weakening (Lemma~\ref{lemma:FS-weakening}) we
     know $[[G, [v/x]G' |- v : e1 th]]$.

     The remainder of the cases follow similarly to the cases
     presented above.
  \end{itemize}
\end{proof}
% The second basic result is kinding conversion.  This is allows the
% substitution of equals for equals in types, and is needed in the proof
% of the second basic result, regularity.
% \begin{lemma}[Kinding conversion]
%   \label{lemma:kinding_conversion}
%   Suppose $[[G |- e : e' th]]$ and $\Gamma \tvdash{L} p:a = a'$.  Then
%   \begin{itemize}
%   \item[i.]  if $[[G]] \equiv [[ G', z : th' [a/y]b,G'']]$, then $[[G', z : th [a'/y]b,G'' |- e : e' th]]$, and 
%   \item[ii.] if $[[e == [a/y]b ]]$, then $[[G |- [a'/y]b:e' th]]$.
%   \end{itemize}
% \end{lemma}
% \begin{proof}
%   The is a proof by mutual induction on the form of the first assumed
%   typing derivation; we only give non-trivial cases.  We first prove
%   part i, and then part ii.
%   \begin{itemize}
%   \item[i.] The two most interesting cases for this part are the case
%     of the variable typing rule which uses both parts of the induction
%     hypothesis, and the equality type kinding rule which uses the
%     assumption that $[[a]]$ is equal to $[[a']]$.
%     \begin{itemize}
%     \item[Case.] \ \\
%       \begin{center}
%         \begin{math}
%           $$\mprset{flushleft}
%           \inferrule* [right=Var] {
%             [[G |- e'  : Type  th]]
%             \\\\
%             [[x : th e' in G]]
%           }{[[G |- x : e' th]]}        
%         \end{math}
%       \end{center}
%       Now if $[[x]]$ is distinct from $[[z]]$, then this case follows by applying the induction hypothesis to
%       the premise $[[G |- e'  : Type  th]]$, followed by the above rule.  So conisder when $[[x == z]]$.  Then
%       the above assumption is equivalent to the following (by expanding all definitions):
%       \begin{center}
%         \begin{math}
%           $$\mprset{flushleft}
%           \inferrule* [right=Var] {
%             [[G', z : th' [a/y]b,G'' |- [a/y]b : Type  th]]
%             \\\\
%             [[z : th' [a/y]b in (G', z : th' [a/y]b,G'')]]
%           }{[[G', z : th' [a/y]b,G'' |- z : [a/y]b th']]}        
%         \end{math}
%       \end{center}
%       Now by applying both parts of the induction hypothesis to \\
%       $[[G', z : th' [a/y]b,G'' |- [a/y]b : Type  th]]$
%       we may conclude $[[G', z : th' [a'/y]b,G'' |- [a'/y]b : Type  th]]$.  We may conclude this case by applying
%       the $\FSdrulename{Var}$ typing rule using the previous fact.

%     \item[Case.] \ \\
%       \begin{center}
%         \begin{math}
%           $$\mprset{flushleft}
%           \inferrule* [right=K\_Eq] {
%             [[G |- e1 : e2 th1]]
%             \\\\
%             [[G |- e3 : e4 th2]]
%           }{[[G |- e1 = e3 : Type  L]]}
%         \end{math}
%       \end{center}
%       In this case we have $[[e == (e1 = e3)]]$ and $[[e' == Type]]$.  If neither $[[e1]]$ nor $[[e3]]$
%       are $[[z]]$, then this case follows by the induction hypothesis followed by reapplying the 
%       $\FSdrulename{K\_Eq}$ typing rule, so suppose $[[e1 == z]]$.  Then
%       the previous typing assumption is equivalent to the following (expanding all definitions):
%       \begin{center}
%         \begin{math}
%           $$\mprset{flushleft}
%           \inferrule* [right=K\_Eq] {
%             [[G', z : th' [a/y]b,G'' |- z : [a/y]b th']]
%             \\\\
%             [[G', z : th' [a/y]b,G'' |- e3 : e4 th2]]
%           }{[[G', z : th' [a/y]b,G'' |- z = e3 : Type  L]]}
%         \end{math}
%       \end{center}
%       Now by applying part i of the induction hypothesis to $[[G', z : th' [a/y]b,G'' |- z : [a/y]b th']]$ we may conclude
%       $[[G', z : th' [a'/y]b,G'' |- z : [a/y]b th']]$.  By assumption we know $[[G |- p : a = a' L]]$. So by applying the
%       $\FSdrulename{conv}$ typing rule using $[[G', z : th' [a'/y]b,G'' |- z : [a/y]b th']]$, we may conclude,
%       $[[G', z : th' [a'/y]b,G'' |- z : [a'/y]b th']]$.  Finally, if $[[e3]]$ is distinct from $[[z]]$, then we may
%       conclude our case by applying the induction to the typing assumption for $[[e3]]$ above followed by applying
%       the $\FSdrulename{K\_Eq}$ rule to the previous fact and $[[G', z : th' [a'/y]b,G'' |- z : [a'/y]b th']]$.
%       If $[[e3 == z]]$, then we may repeat our previous argument for $[[e1]]$, and then reapply the rule.
%     \end{itemize}
    
    
%     \item[ii.] \ \\
    
%     \begin{itemize}
%     \item[Case.] \ \\
%       \begin{center}
%         \begin{math}
%           $$\mprset{flushleft}
%           \inferrule* [right=Var] {
%             [[G |- e'  : Type  th]]
%             \\\\
%             [[x : th e' in G]]
%           }{[[G |- x : e' th]]}        
%         \end{math}
%       \end{center}
%       So suppose $[[x == [a/y]b]]$.  This implies that either $[[b]]$
%       is a variable $[[x]]$ distinct from $[[y]]$ -- and this case
%       follows trivially -- or $[[b == y]]$, and $[[a == x]]$.  Suppose
%       the latter.  This implies that $[[a]]$ and $[[x]]$
%       have the same type. 

%     \item[Case.] \ \\
%       \begin{center}
%         \begin{math}
%           $$\mprset{flushleft}
%           \inferrule* [right=K\_Pi] {
%             [[G |- e1 : Type th1]]
%             \\\\
%             [[G , x : th1 e1 |- e2 : Type th]]
%           }{[[G |- ( x : th1 e1 ) ep -> e2 : Type th]]}
%         \end{math}
%       \end{center}
      

%     \end{itemize}
    
%   \end{itemize}
% \end{proof} 
The third result is regularity, which ensures that if an expression
has a type, then its type is well typed.  Recall that in the logical
fragment $[[Type]] : [[Type]]$ does not hold, thus if $[[e]]$ is
joinable with $[[Type]]$, then $[[G |- e' : e L]]$ does not imply that
$[[G |- e : Type L]]$.  However, this does hold in the programmatic
fragment.  Therefore, regularity has the following statement and
proof.  
\begin{lemma}[Regularity]
  \label{lemma:regularity}
  \begin{itemize}
  \item[i.] If $[[G |- e':e L]]$ and it is not the case that $[[e == Type]]$, then $[[G |- e:Type L]]$.
  \item[ii.] If $[[G |- e':e P]]$ then $[[G |- e:Type P]]$.
  \end{itemize}
\end{lemma}
\begin{proof}
  This is a proof by induction on the form of the assumed typing
  derivation.  The most interesting cases are presented below; all
  other cases are either similar to the cases given here or are
  trivial.  If it is not the case that $[[e == Type]]$, then both
  proofs can be given simultaneously.  In fact, the proof of part ii
  when $[[e == Type]]$ holds is trivial, thus we do not present it
  here.
  
  \begin{itemize}
  \item[Case.] \ \\
    \begin{center}
      \begin{math}
        $$\mprset{flushleft}
        \inferrule* [right=Lam] {
          [[G |- e2 : Type th]]
          \\\\
          [[G, x : th e2 |- e1 : e3   th']]          
        }{[[G |- \ x . e1 : (x :th e2) + -> e3   th']]}
      \end{math}
    \end{center}
    By assumption we know $\Gamma \tvdash{\theta} e_2:[[Type]]$ and by the induction hypothesis,
    $\Gamma,x:^\theta e_2 \tvdash{\theta'} e_3:[[Type]]$. Finally by applying 
    $\FSdrulename{K\_Pi}$, $\Gamma \tvdash{\theta'} \arrowT{x}{\theta}{e_2}{+}{e_3}:[[Type]]$.

  \item[Case.] \ \\
    \begin{center}
      $\FSdruleRecNat{}$
    \end{center}
    By the induction hypothesis, 
    $\Gamma, x:^L \nat,
    f:^L \arrowT{y}{L}{\nat}{+}{\arrowT{p}{L}{x=S\ y}{-}{[y/x]e_2}} \tvdash{L} e_2:[[Type]]$.  Since
    $f$ is not free in $e_2$ we know $\Gamma, x:^L \nat \tvdash{L} e_2:[[Type]]$.  Finally,
    by $\FSdrulename{K\_Pi}$ using $\Gamma, x:^L \nat \tvdash{L} e_2:[[Type]]$ and
    $\FSdrulename{K\_Nat}$, $\Gamma \tvdash{L} \arrowT{x}{L}{\nat}{+}{e_2}:[[Type]]$.

  \item[Case.] \ \\
    \begin{center}
      \begin{math}
        $$\mprset{flushleft}
        \inferrule* [right=Rec] {
          [[G |- e1 : Type th']]
          \\\\
          [[G, f : th (x : th' e1)+ -> e2, x : th' e1 |- e3 : e2   th]]          
        }{[[G |- rec f x e3 : (x : th' e1)+ -> e2   P]]}
      \end{math}
    \end{center}
    By assumption $\Gamma \tvdash{\theta'} e_1:[[Type]]$ and by the induction hypothesis
    $\Gamma, f:^\theta \arrowT{x}{\theta'}{e_1}{+}{e_2},x:^{\theta'} e_1 \tvdash{\theta} e_2:[[Type]]$.
    Now by $\FSdrulename{K\_Pi}$, $\Gamma, f:^\theta \arrowT{x}{\theta'}{e_1}{+}{e_2} 
    \tvdash{\theta} \arrowT{x}{\theta'}{e_1}{+}{e_2}:[[Type]]$. Clearly, $f$ is not free in
    $\arrowT{x}{\theta'}{e_1}{+}{e_2}$, thus, 
    $\Gamma \tvdash{\theta} \arrowT{x}{\theta'}{e_1}{+}{e_2}:[[Type]]$.

  \end{itemize}
\end{proof}

The next result is an inversion principle, and this is needed in the
prove of type preservation.  This principle states that for certain
term constructors if we know the conclusion of their typing rule is
derivable, then we know the premises are derivable as well.  Inversion
in general is very hard to prove for advanced type systems like
Freedom of Speech, so we only prove the inversion principles that are
actually needed.

\begin{lemma}[Inversion]
  \label{lemma:inversion}
  \begin{itemize}
  \item[i.] If $\Gamma \tvdash{\theta'} \lambda x.e:\arrowT{x}{\theta}{e_1}{+}{e_2}$, then 
    $\Gamma \tvdash{L} p:\arrowT{x}{\theta}{e_1}{+}{e_2} = \arrowT{x}{\theta}{a}{+}{b}$ and
    $\Gamma,x:^\theta a \tvdash{\theta'} e:b$.

  \item[ii.] If $[[G |- rec f x v : (x : L Nat) + -> e L]]$, then 
    $[[G |- p : (x : L Nat) + -> e = (x : L a) + -> b L]]$ and
    $[[G, x : L a, f : L (y : L a)+ -> (p : L x = S y)- -> [y/x]b |- v : b  L]]$.

  \item[ii.] If $[[G |- rec f x e : (x : th' e1) + -> e2 P]]$, then 
    $[[G |- p : (x : th' e1) + -> e2 = (x : th' a) + -> b L]]$ and
    $[[G, x : th' a, f : th (x : th' a)+ -> b |- e : b  th]]$.
    
  \end{itemize}
\end{lemma}
\begin{proof}
  We proceed by induction on the form of the assumed typing
  derivation.  In each part there are exactly two cases.  The first is
  when the assumed typing derivation ends with the introduction typing
  rule for the respective term constructor, or when the derivation
  ends with the conversion rule.  The former is trivial, so we only
  give the cases for the latter.
  \begin{itemize}    
  \item[Case.]\ \\
    \begin{center}
      \begin{math}
        $$\mprset{flushleft}
        \inferrule* [right=\FSdrulename{Conv}] {
          \Gamma \tvdash{\theta'} e':[e'_1/y]e'_2
          \\\\
          \Gamma \tvdash{L} e'':e'_1 = e''_1
        }{\Gamma \tvdash{\theta'} e':[e''_1/y]e'_2}
      \end{math}
    \end{center}
    \begin{itemize}
    \item[i.] 
      Here $e' \equiv \lambda x.e$ and $[e''_1/y]e'_2 \equiv \arrowT{x}{\theta}{e_1}{+}{e_2}$.  Now we have two cases to
      consider, either $[[e'2]]$ is $[[y]]$ and $[[e'1]]$ is a
      dependent product, or $[[e'2]]$ is a dependent product.  If the
      former is true, then we know $[[e1'']]$ is a dependent product,
      and this part follows by first applying the induction hypothesis
      to $\Gamma \tvdash{\theta'} e':[e'_1/y]e'_2$, followed by
      applying the $\FSdrulename{Conv}$ typing rule.

      Suppose the $[[e'2]]$ is a dependent product. Then
      $[e''_1/y]e'_2 \equiv
      \arrowT{x}{\theta}{[e''_1/y]r}{+}{[e''_1/y]s}$ for some
      expressions $r$ and $s$.  Clearly, $[e'_1/y]e'_2 \equiv
      \arrowT{x}{\theta}{[e'_1/y]r}{+}{[e'_1/y]s}$.  By the induction
      hypothesis, $\Gamma \tvdash{\theta'} e':[e'_1/y]e'_2$ implies
      $\Gamma,x:^\theta a \tvdash{\theta'} e:b$ and $\Gamma \tvdash{L}
      $ $p:(\arrowT{x}{\theta}{[e'_1/y]r}{+}{[e'_1/y]s}) =
      (\arrowT{x}{\theta}{a}{+}{b})$.  Finally, since $\Gamma
      \tvdash{L} e'':e'_1 = e''_1$ we can apply $\FSdrulename{Conv}$
      to obtain $\Gamma \tvdash{\theta'} $
      $p:(\arrowT{x}{\theta}{[e''_1/y]r}{+}{[e''_1/y]s}) =
      (\arrowT{x}{\theta}{a}{+}{b})$.

    \item[ii.] Here $[[e' == rec f x v]]$ and $[e''_1/y]e'_2 \equiv \arrowT{x}{L}{Nat}{+}{e}$.  
      Just as we saw in the previous part we have two cases to consider, either $[[e'2]]$ is $[[y]]$ and $[[e'1]]$ is a
      dependent product, or $[[e'2]]$ is a dependent product.  If the
      former is true, then we know $[[e1'']]$ is a dependent product,
      and this part follows by first applying the induction hypothesis
      to $\Gamma \tvdash{\theta'} e':[e'_1/y]e'_2$, followed by
      applying the $\FSdrulename{Conv}$ typing rule.


      Suppose the $[[e'2]]$ is a dependent product.  Then 
      $[e''_1/y]e'_2 \equiv \arrowT{x}{L}{[e''_1/y]r}{+}{[e''_1/y]s}$ for some
      expressions $r$ and $s$.  Clearly, $[e'_1/y]e'_2 \equiv
      \arrowT{x}{L}{[e'_1/y]r}{+}{[e'_1/y]s}$.  By the induction
      hypothesis, $\Gamma \tvdash{\theta'} e':[e'_1/y]e'_2$ implies
      $\Gamma,x:^\theta a, [[f : L (y : L a)+ -> (p : L x = S y)- -> [y/x]b]] \tvdash{\theta'} e:b$ and 
      $\Gamma \tvdash{L} p:(\arrowT{x}{\theta}{[e'_1/y]r}{+}{[e'_1/y]s}) =
      (\arrowT{x}{\theta}{a}{+}{b})$.  Finally, we know $\Gamma \tvdash{L} e'':e'_1 = e''_1$ by assumption
      so we can apply $\FSdrulename{Conv}$ to obtain $\Gamma \tvdash{L} p:(\arrowT{x}{\theta}{[e''_1/y]r}{+}{[e''_1/y]s}) = (\arrowT{x}{\theta}{a}{+}{b})$.

    \item[iii.] This part is similar to the previous part.
    \end{itemize}
  \end{itemize}
\end{proof}
% section basic_results (end)

\section{Type Preservation}
\label{sec:type_preservation}
We are now in a position to prove type preservation.  The proof is
straightforward, and holds by induction on the typing derivation.
Type preservation is definately a result that should be proven for any
type theory or programming language being designed, implemented, or
studied.  This result ensures that reduction does not wonder outside
the bounds of the type system.  If type preservation did not hold,
then one could start with a proof $[[e]]$ of some type, and then use
reduction to obtain that $[[e]]$ is a proof of some other type, or that
$[[e]]$ is not a proof at all, or if one starts with the application
of some program to a series of arguments that is supposed to return a
natural number, but then after reduction ends up with some other type,
would make reasoning about the correctness of the original program
impossible!

Unusually so, the proof of logical consistency of freedom of speech
actually depends on type preservation.  It is usually the case that
they are important, but distinct results.  In the next section we will
define an interpretation of types to prove weak normalization.  Due to
the collapsed nature of the freedom of speech language these
interpretations depend heavily on the typing relation. It is this
dependency that results in the proofs of the critical properties of
the interpretation of types to depend on type preservation.  We
conclude this section with the statement and proof of type
preservation.
 
\begin{thm}[Preservation]
  \label{thm:preservation}
  If $\Gamma \tvdash{\theta} a:c$ and $a \redto b$ then $\Gamma \tvdash{\theta} b:c$.
\end{thm}
\begin{proof}
  We proceed by induction on the assumed typing derivation and only consider non-vacuous 
  cases.  We will implicitly assume $a \redto b$ in each case.

  \begin{itemize}
  \item[Case.]\ \\
    \begin{center}
      $\FSdruleAppPiTerm{}$
    \end{center}
    We have three cases to consider either $e \redto e'$, $e \equiv \lambda x.e'$
    and $e\ v \redto [v/x]e'$, or $[[e == rec x f v']]$ and $e\,v \redto [ [[rec f x v']]/f][v/x]v'$.  
    Consider the former, by the induction hypothesis, if $e \redto e'$ then 
    $\Gamma \tvdash{L} e':\arrowT{x}{\theta}{e_1}{+}{e_2}$.  Now by applying the same
    rule, $\Gamma \tvdash{L} e'\ v:[v/x]e_2$.
    
    \noindent
    Now suppose the second case, by assumption we know $\Gamma \tvdash{\theta} v:e_1$ and
    $\Gamma \tvdash{L} \lambda x.e':\arrowT{x}{\theta}{e_1}{+}{e_2}$. By the Inversion Lemma (Lemma~\ref{lemma:inversion}), 
    $\Gamma,x:^\theta e_1 \tvdash{L} e':e_2$.  Thus, by substitution for typing (Lemma~\ref{lemma:substitution}),
    $\Gamma \tvdash{L}[v/x]e':[v/x]e_2$.

    The third case follows similarly to the previous case.  First,
    apply inversion (Lemma~\ref{lemma:inversion}) to the typing
    assumption for $[[e]]$ followed by substitution for typing (Lemma~\ref{lemma:substitution}).

  \item[Case.]\ \\
    \begin{center}
      $\FSdruleAppAllTerm{}$
    \end{center}
    By the induction hypothesis, if $e \redto e'$ then 
    $\Gamma \tvdash{L} e':\arrowT{x}{\theta}{e_1}{-}{e_2}$.  Thus, by applying 
    $\FSdrulename{AppAllTerm}$, $\Gamma \tvdash{L} e':[v/x]e_2$.
    
  \item[Case.]\ \\
    \begin{center}
      $\FSdruleConv{}$
    \end{center}
    By the induction hypothesis, if $e \redto e''$ then $\Gamma \tvdash{\theta} e'':[e_1/x]e_2$.
    By applying $\FSdrulename{Conv}$, $\Gamma \tvdash{\theta} e'':[e'_1/x]e_2$.

  \item[Case.]\ \\
    \begin{center}
      $\FSdruleCoerce{}$
    \end{center}
    By the induction hypothesis, if $e \redto e'$ then $\Gamma \tvdash{L} e':e_1$ and by applying
    $\FSdrulename{Coerce}$, $\Gamma \tvdash{P} e':e_1$.
    
  \item[Case.]\ \\
    \begin{center}
      $\FSdruleRec{}$
    \end{center}
    By the induction hypothesis, if $e \redto e'$ then 
    $\Gamma, f:^\theta \arrowT{x}{\theta'}{e_1}{+}{e_2},x:^{\theta'} e_1 \tvdash{\theta} e':e_2$ 
    and by applying $\FSdrulename{Rec}$,
    $\Gamma \tvdash{P} \rec{f}{x}{e'}:\arrowT{x}{\theta'}{e_1}{+}{e_2}$.
  \end{itemize}
\end{proof}
% section type_preservation (end)

\section{Logical consistency}
\label{sec:logical_consistency}

One recurring statement throughout this thesis is that if we are to
consider a type theory or programming language, or even a fragment of
one as a logic, then that logic must be proven consistent.  We have to
believe what it is telling us is true!  If consistency has not been
shown, then neither the designer nor the programmer has the right to
consider any part of the language as containing proofs or formulas.
We have claimed that there is a logical fragment of freedom of speech,
thus we must show that this fragment is consistent.  The proof of
logical consistency is the topic of this section.

We prove logical consistency using reducibility candidates first
proposed by Girard.  For an overview of the reducibility method see
Section~\ref{sec:tait-griard_reduciblity}.  We begin with the
definition of the interpretation of types.

\begin{definition}
  \label{def:FS-interp}
  Let $J = \{e\ |\ e \join join \vee e \join injdom \vee e \join
  injran\}$ be the set of all the proofs of equations and $V$ be the
  set of terms such that $t \normto v$, where $v$ is a value.  We
  define the interpretation of types as follows:
  \begin{center}
    \small
    \begin{tabular}{lll}
      \begin{tabular}{lll}
        $e \in \interp{\nat}^{L}_\rho$ if and only if\\
        \begin{tabular}{lll}
          -- $[[. |- e:Nat L]]$ \\
          -- $e \in N = \{e'\ |\ e' \normto [[S]]^n\ [[Z]]\ where \ n \in \nat\}$\\
          \ \\
          \ \\
        \end{tabular}\\ 
      \end{tabular}
      &
      \begin{tabular}{lll}         
        $e \in \interp{[[(x : th e1) + -> e2]]}^{L}_\rho$ if and only if \\
        \begin{tabular}{lll}
          -- $[[. |- e : (x : th r e1) + -> r e2 L]]$ \\
          -- $[[. |- r ((x : th e1) + -> e2):Type th]]$ \\
          -- $e \in V$\\
          -- $\forall e' \in \interp{e_1}^{\theta}_{\rho} . e\ e' \in \interp{e_2}^L_{\rho[x \mapsto e']}$
        \end{tabular}
      \end{tabular}\\
      \\
      \begin{tabular}{lll}          
        $e \in \interp{\arrowT{x}{\theta}{e_1}{-}{e_2}}^{L}_\rho$ if and only if \\
        \begin{tabular}{lll}
          -- $[[. |- e : (x : th r e1) - -> r e2 L]]$ \\
          -- $[[.  |- r ((x : th e1) - -> e2):Type th]]$ \\ 
          -- $e \in V$ \\
          -- $\forall e' \in \interp{e_1}^{\theta}_{\rho} . e \in \interp{e_2}^L_{\rho[x \mapsto e']}$\\
        \end{tabular}                  
      \end{tabular}
      &
      \begin{tabular}{lll}
        $e \in \interp{e_1 = e_2}^{L}_\rho$ if and only if \\
        \begin{tabular}{lll}
          -- $\cdot \tvdash{L} e:\rho\ e_1 = \rho\ e_2$ \\
          -- $\cdot \tvdash{\theta} \rho\ (e_1 = e_2):[[Type]]$\\
          -- $e \in J$\\
          -- $\rho\ e_1 \join \rho\ e_2$\\
        \end{tabular}
      \end{tabular}\\
      \\
      \begin{tabular}{lll}          
        $e \in \interp{e'}^P_\rho$ if and only if \\
        \begin{tabular}{lll}
          -- $\cdot \tvdash{P} e:\rho\ e'$ \\
          -- $\cdot \tvdash{\theta} \rho\ e':[[Type]]$\\
          -- $e \in V$
        \end{tabular}
      \end{tabular}
    \end{tabular}
  \end{center}
\end{definition}
The interpretation of types consists of two parts, a deep
interpretation and a shallow one.  We give a deep interpretation of
the logical fragment where we characterize the termination behavior of
the programs, while we give a shallow interpretation of the programs
of the programmatic fragment.  The only property we can guarantee of
programmatic programs is that the terminating programs are well typed.
Note that the interpretation of types depend heavily on the typing
judgment, this is the dependency mentioned in the previous section on
type preservation.  Thus, the proofs of the critical properties,
especially CR-Pres, depend on type preservation.  Finally, the
interpretation of types depend on the notion of well-formed
substitutions which are defined in Figure~\ref{fig:fs-wf-subs}.

\begin{figure}[t]  
  \begin{center}
    \begin{tabular}{ccc}
      \begin{math}
        $$\mprset{flushleft}
        \inferrule* [] {\ \\}{
          \emptyset \in \interp{\cdot}
        }
      \end{math}
       & & 
      \begin{math}
        $$\mprset{flushleft}
        \inferrule*[]{
          \Gamma \tvdash{L} e':[[Type]]
          \\
          \rho \in \interp{\Gamma}
          \\
          e \in \interp{e'}^L_\rho
        }{\rho \cup \{(x,e)\} \in \interp{\Gamma,x:^L e'}}
      \end{math}
      \\
      & & \\
      \begin{math}
        $$\mprset{flushleft}
        \inferrule*[]{
          \Gamma \tvdash{P} e':[[Type]]
          \\
          \rho \in \interp{\Gamma}
          \\
          v \in \interp{e'}^P_\rho
        }{\rho \cup \{(x,v)\} \in \interp{\Gamma,x:^P e'}}
      \end{math}
      & &\\
    \end{tabular}  
  \end{center}
  \caption{Well-formed substitutions}
  \label{fig:fs-wf-subs}
\end{figure}

Before we can move on we must justify why the interpretation of types
covers all cases, especially, for the logical fragment.  We must show
that there is no type-level computation, and that the
$[[Type]]:[[Type]]$ axiom is purely programmatic.  The following two
lemmata establish this fact:

\begin{lemma}[$[[Type]]:[[Type]]$ is not Logical]
  \label{lemma:type:type_is_not_logical}
  It is not the case that $[[. |- Type : Type L]]$.
\end{lemma}
\begin{proof}
  Suppose it is the case that $[[. |- Type : Type L]]$ is derivable.
  Then it must be the case that its derivation ends with the one of
  $\FSdrulename{AppAllTerm}$ or $\FSdrulename{Conv}$, but both of
  which would have $[[. |- Type : Type L]]$ as a premise.  No other
  rules are applicabile.  Thus, $[[. |- Type : Type L]]$ is a
  non-terminating derivation, a contradiction.
\end{proof}

\begin{lemma}[Characterization of Logical Types]
  \label{lemma:characterization}
  If $[[. |- e : Type L]]$, then $[[e]] \equiv [[Nat]]$, $[[e]] \equiv
  [[e1 = e2]]$, or $[[e]] \equiv [[(x : th e1) ep -> e2]]$ for some
  expressions $[[e1]]$, $[[e2]]$, staging classifier $[[th]]$ and
  consistency classifier $[[ep]]$.
\end{lemma}
\begin{proof}
  This is a proof by induction on the assumed typing derivation.
  The previous lemma imples that $[[e]]$ cannot be $[[Type]]$.  Thus,
  we only have the following non-trivial cases:
  \begin{itemize}
  \item[Case.]\ \\ 
    \begin{center}
      \begin{math}
        $$\mprset{flushleft}
        \inferrule* [right=\ifrName{K\_Nat}] {
          \,
        }{[[. |- Nat : Type L]]}
      \end{math}
    \end{center}
    In this case $[[e]] \equiv [[Nat]]$, thus we obtain our result.

  \item[Case.]\ \\ 
    \begin{center}
      \begin{math}
        $$\mprset{flushleft}
        \inferrule* [right=\ifrName{K\_Pi}] {
          [[. |- e1 : Type th']]
          \\\\
          [[. , x : th' e1 |- e2 : Type L]]
        }{[[. |- ( x : th' e1 ) ep -> e2 : Type L]]}
      \end{math}
    \end{center}        
    Similar to the previous case.

    \item[Case.]\ \\ 
    \begin{center}
      \begin{math}
        $$\mprset{flushleft}
        \inferrule* [right=\ifrName{K\_Eq}] {
          [[. |- e : e1    th1]]
          \\\\
          [[. |- e' : e2   th2]]
        }{[[. |- e = e' : Type  L]]}
      \end{math}
    \end{center}
    Similar to the previous case.
    
  \item[Case.]\ \\ 
    \begin{center}
      \begin{math}
        $$\mprset{flushleft}
        \inferrule* [right=\ifrName{AppPiTerm}] {
          [[. |- [v/x] Type : Type L]]
          \\\\
          [[. |- e : (x : th e1)+ -> Type   L]]
          \\\\
          [[. |- v : e1 th]]
        }{[[. |- e v : [v/x] Type  L]]}
      \end{math}
    \end{center}
    This case is impossible, because it requires $[[. |- [v/x] Type :
    Type L]]$ which is equivalent to $[[. |- Type : Type L]]$ to be
    derivable, but by the previous lemma this is impossible.

  \item[Case.]\ \\ 
    \begin{center}
      \begin{math}
        $$\mprset{flushleft}
        \inferrule* [right=\ifrName{AppAllTerm}] {
          [[. |- [v/x] Type : Type L]]
          \\\\
          [[. |- e : (x : th e1)- -> e2   L]]
          \\\\
          [[. |- v : e1   th]]
        }{[[. |- e : [v/x] Type   L]]}
      \end{math}
    \end{center}
    Similar to the previous case.

    \item[Case.]\ \\ 
    \begin{center}
      \begin{math}
        $$\mprset{flushleft}
        \inferrule* [right=\ifrName{Conv}] {
          [[. |- [e'1/x] Type : Type L]]
          \\\\
          [[. |- e : [e1/x] Type  L]]
          \\\\
          [[. |- e' : e1 = e1'   L]]
        }{[[. |- e : [e1'/x] Type  L]]}
      \end{math}
    \end{center}
    Similar to the previous case.  
  \end{itemize}
\end{proof}

We now state and prove the critical properties of the interptretation
of types.  These are standard, and so we simply list them with their
proofs.

\begin{lemma}[$\CRI$]
  \label{lemma:cri}
  If $t \in \interp{e}^\theta_\rho$ then $t$ is closed and $t \in V$.
\end{lemma}
\begin{proof}
  This holds by definition of the interpretation of types.
\end{proof}

\begin{lemma}[$\CRII$]
  \label{lemma:crii}
  If $t \in \interp{e}^\theta_\rho$ and $t \redto t'$ then $t' \in \interp{e}^\theta_\rho$
\end{lemma}
\begin{proof}
  This is a proof by structural induction on $e$.  By assumption we know 
  $\cdot \tvdash{\theta} \rho\ e:[[Type]]$, for each case below.  Hence, we assume this for
  the remainder of the proof.  In each of the function-type cases below we 
  assume $t \redto t'$, and $t' \in V$, because in each case $t \in V$.  We have two cases
  to consider when $\theta = L$ and when $\theta = P$.  The latter is trivial so we only
  consider the former.

  \begin{itemize}
  \item[Case.] Let $e \equiv \nat$.  
    Suppose $t \in \interp{\nat}^L_\rho$.  Then by the definition of the 
    interpretation of types, $t \in N$ and $t$ is closed.  Since CBV is deterministic,
    if $t \redto t'$ then $t' \in N$, and $t$ being closed implies $t'$ is closed.  At this
    point we still need show that $\cdot \tvdash{L} t':\nat$.  This easily follows from
    type preservation (Theorem~\ref{thm:preservation}). Thus, $t' \in \interp{\nat}^L_\rho$.

  \item[Case.] Let $e \equiv (x :^\theta e_1)^+ \rightarrow e_2$.    
    Suppose $t \in \interp{e}^L_\rho$.  By the definition of the interpretation of types we know 
    for all $e' \in \interp{e_1}^\theta_\rho$, we have 
    $t\ e' \in \interp{e_2}^L_{\rho[x \mapsto e']}$.  
    Let $e'' \in \interp{e_1}^\theta_\rho$.  By the definition of left-to-right CBV, 
    $t\ e'' \redto t'\ e''$.  By the induction hypothesis, 
    $t'\ e'' \in \interp{e_2}^L_{\rho[x \mapsto e'']}$.  Now we need to show
    $\cdot \tvdash{L} t':(x :^\theta \rho\ e_1)^+ \rightarrow \rho\ e_2$.  This easly follows
    from type preservation.  Thus, by the definition 
    of the interpretation of types, $t' \in \interp{e}^L_{\rho}$, because $e''$ is arbitrary.
    
  \item[Case.] Let $e \equiv (x :^\theta e_1)^- \to e_2$.
    Suppose $t \in \interp{e}^L_\rho$.  By type preservation we know 
    $\cdot \tvdash{L} t':(x :^\theta \rho\ e_1)^- \to \rho\ e_2$.
    Let $u \in \interp{e_1}^\theta_\rho$. Then 
    $t \in \interp{e_2}^L_{\rho[x \mapsto u]}$.  By the induction hypothesis,
    $t' \in \interp{e_2}^L_{\rho[x \mapsto u]}$.  Thus, by the definition
    of the interpretation of types, $t' \in \interp{e}^L_\rho$.
      
  \item[Case.] Let $e \equiv e_1 = e_2$ and $t \in \interp{e}^L_\rho$.  
    By type preservation we know 
    $\cdot \tvdash{L} t':\rho\ e_1 = \rho\ e_2$.  By the definition of the 
    interpretation of types, $t \in V$, $\rho\ e_1 \join \rho\ e_2$, hence, 
    $t' \in V$, because $t \redto t'$.  Thus, again by the definition 
    of the interpretation of types, $t' \in \interp{e}^L_\rho$.    
  \end{itemize}
\end{proof}

\begin{lemma}[$\CRIII$]
  \label{lemma:criii}
  If $t \redto t'$, $\cdot \tvdash{L} t:\rho\ e$, and $t' \in \interp{e}^L_\rho$ 
  then $t \in \interp{e}^L_\rho$.
\end{lemma}
\begin{proof}
  This is a proof by structural induction on $e$.  
  By assumption we know $\cdot \tvdash{\theta} \rho\ e:[[Type]]$, for each case below.  Hence, we 
  assume this for the remainder of the proof.  In each of the cases below we assume
  $t \redto t'$, $t$ is closed, and $t' \in \interp{e}^L_\rho$ and in the function-type cases we 
  assume $t \in V$, because in each case $t' \in V$.  By assumption $t$ has the required type,
  thus we omit this assumption from the remainder of the proof.

  \begin{itemize}
  \item[Case.] Let $e \equiv \nat$.  
    By the definition of the interpretation of types we know
    $t' \in N$ and $t'$ is closed.  Now since CBV is deterministic and $t \redto t'$ we know
    $t \in N$.  Thus, $t \in \interp{\nat}^L_\rho$.

  \item[Case.] Let $e \equiv (x :^\theta e_1)^+ \rightarrow e_2$.    
    By the definition of the interpretation of types,
    for all $e' \in \interp{e_1}^\theta_\rho$, we have 
    $t'\ e' \in \interp{e_2}^L_{\rho[x \mapsto e']}$.
    Let $e'' \in \interp{e_1}^\theta_\rho$.  By the definition of left-to-right 
    CBV, $t\ e'' \redto t'\ e''$ and by the induction hypothesis, 
    $t\ e'' \in \interp{e_2}^L_{\rho[x \mapsto e'']}$.  By the definition of the interpretation of
    types, $t \in \interp{e}^L_{\rho}$.

  \item[Case.] Let $e \equiv (x :^\theta e_1)^- \to e_2$ and $u \in \interp{e_1}^\theta_\rho$.  
    Then $t' \in \interp{e_2}^L_{\rho[x \mapsto u]}$.  By the 
    induction hypothesis, $t \in \interp{e_2}^L_{\rho[x \mapsto u]}$, thus, by
    the definition of the interpretation of types, $t \in \interp{e}^L_\rho$.

  \item[Case.] Let $e \equiv e_1 = e_2$.
    By the definition of the interpretation of types, $t' \in V$,
    $\rho\ e_1 \join \rho\ e_2$, hence, $t \in V$, because 
    $t \redto t'$.  Therefore, 
    by the definition of the interpretation of types, $t \in \interp{e}^L_\rho$.
  \end{itemize}
\end{proof}
\noindent
The following results about substitution are also standard.
\begin{lemma}[Substitution Distribution]
  \label{lemma:movable_subs}
  $\interp{e}^\theta_{\rho[x \mapsto e']} = \interp{[e'/x]e}^\theta_\rho$
\end{lemma}
\begin{proof}
  This is a proof by induction on the form of $e$.  We first consider when $\theta = L$ and
  then when $\theta = P$.  Note that we do not show both directions of the equality.  We only
  prove left to right the other direction is similar.
  
  \begin{itemize}
  \item[Case.] Let $e \equiv \nat$.  
    Since $\rho\ \nat = \nat$ for any substitution $\rho$, clearly
    $\interp{e}^L_{\rho[x \mapsto e']} = \interp{[e'/x]e}^L_\rho$.

  \item[Case.] Let $e \equiv \arrowT{y}{\theta}{e_1}{+}{e_2}$.  Suppose 
    $a \in \interp{e}^\theta_{\rho[x \mapsto e']}$.  Then by the interpretations of types,
    $\cdot \tvdash{\theta} a:
    \arrowT{y}{\theta}{\rho[x \mapsto e']\ e_1}{+}{(\rho[x \mapsto e']\ e_2)}$, 
    $a \in V$,
    and for any $a' \in \interp{e_1}^L_{\rho[x \mapsto e']}$ we have 
    $a\ a' \in \interp{e_2}^L_{\rho[x \mapsto e'][y \mapsto a']}$.  Clearly, 
    $\rho[x \mapsto e'][y \mapsto a']$ is equivalent to
    $\rho[y \mapsto [e'/x]a'][x \mapsto e']$, thus, 
    $a\ a' \in \interp{e_2}^L_{\rho[y \mapsto [e'/x]a'][x \mapsto e']}$.  Now by the induction
    hypothesis, $\interp{e_1}^L_{\rho[x \mapsto e']} = \interp{[e'/x]e_1}^L_{\rho}$ and
    $\interp{e_2}^L_{\rho[y \mapsto [e'/x]a'][x \mapsto e']} = 
    \interp{[e'/x]e_2}^L_{\rho[y \mapsto [e'/x]a']}$.  Therefore, by the definition of the 
    interpretation of types, $\interp{e}^L_{\rho[x \mapsto e']} \subseteq \interp{[e'/x]e}^L_\rho$.

  \item[Case.]  Let $e \equiv \arrowT{y}{\theta}{e_1}{-}{e_2}$.  Similar to the previous case.

  \item[Case.] Let $e \equiv e_1 = e_2$.  Suppose $a \in \interp{e}^\theta_{\rho[x \mapsto e']}$.
    By the definition of the interpretation of types, 
    $\cdot \tvdash{L} a:\rho[x \mapsto e']\ e_1 = \rho[x \mapsto e']\ e_2$, 
    $\cdot \tvdash{L} \rho[x \mapsto e']\ e_1 = \rho[x \mapsto e']\ e_2:[[Type]]$,
    $a \in V$, 
    and $\rho[x \mapsto e']\ e_1 \join \rho[x \mapsto e']\ e_2$.  Clearly, if 
    $\cdot \tvdash{L} a:\rho[x \mapsto e']\ e_1 = \rho[x \mapsto e']\ e_2$ then
    $\cdot \tvdash{L} a:\rho\ [e'/x]e_1 = \rho\ [e'/x]e_2$, the same applies to the kinding
    judgment and
    if $\rho[x \mapsto e']\ e_1 \join \rho[x \mapsto e']\ e_2$ then
    $\rho\ [e'/x]e_1 \join \rho\ [e'/x]e_2$.  Therefore, by the definition of the 
    interpretation of types, 
    $\interp{e}^L_{\rho[x \mapsto e']} \subseteq \interp{[e'/x]e}^L_\rho$.
  \end{itemize}
  
  Now assume $\theta = P$.
  \begin{itemize}
  \item[Case.] Assume $a \in \interp{e}^P_{\rho[x \mapsto e']}$.  By the definition of the 
    interpretation of types, $\cdot \tvdash{P} a:\rho[x \mapsto e']\ e$,
    $\cdot \tvdash{P} \rho[x \mapsto e']\ e:[[Type]]$ and $a$ is a value.
    Just as in the previous case if $\cdot \tvdash{P} a:\rho[x \mapsto e']\ e$ and
    $\cdot \tvdash{P} \rho[x \mapsto e']\ e:[[Type]]$ then
    $\cdot \tvdash{P} a:\rho\ [e'/x]e$ and $\cdot \tvdash{P} \rho\ [e'/x]e:[[Type]]$.  Therefore, by 
    the definition of the interpretation of
    types, $\interp{e}^L_{\rho[x \mapsto e']} \subseteq \interp{[e'/x]e}^L_\rho$.
  \end{itemize}
\end{proof}

% \begin{lemma}[Substitution for kinding and typing]
%   \label{lemma:substitution_kinding_typing}
%   \begin{itemize}
%   \item[i.]   If $\rho \in \interp{\Gamma}$ and $\Gamma \tvdash{\theta} e:[[Type]]$ then 
%     $\cdot \tvdash{\theta} \rho\ e:[[Type]]$.
%   \item[ii.]   If $\rho \in \interp{\Gamma}$ and $\Gamma \tvdash{\theta} v:e$ then 
%     $\cdot \tvdash{\theta} \rho\ v:\rho\ e$.
%   \end{itemize}
% \end{lemma}
\begin{lemma}[Well-formed substitution for typing]
  \label{lemma:substitution_kinding_typing}
  If $\rho \in \interp{\Gamma}$ and $\Gamma,\Gamma' \tvdash{\theta} e:e'$ then $\Gamma' \tvdash{\theta} \rho\ e:\rho\ e'$.
\end{lemma}
\begin{proof}
  This is a proof by induction on the form of the assumped typing
  judgment. We only show a few cases all the others are either
  trivial, or similar to the cases we given below.
  \begin{itemize}      
    \item[Case.]\ \\
      \begin{center}
        \begin{math}
          $$\mprset{flushleft}
          \inferrule* [right=K\_Pi] {
            \Gamma,\Gamma' \tvdash{\theta'} e_1:[[Type]]
            \\\\
            \Gamma,\Gamma',x:^{\theta'} e_1 \tvdash{\theta} e_2:[[Type]]
          }{\Gamma,\Gamma' \tvdash{\theta} \arrowT{x}{\theta'}{e_1}{\epsilon}{e_2}:[[Type]]}
        \end{math}
      \end{center}
      By the induction hypothesis, $\Gamma' \tvdash{\theta'} \rho\ e_1:[[Type]]$ and
      $\Gamma',x:^{\theta'} \rho\ e_1 \tvdash{\theta} \rho\ e_2:[[Type]]$.  Thus, by applying 
      $\FSdrulename{K\_Pi}$ 
      $\Gamma' \tvdash{\theta} \arrowT{x}{\theta'}{\rho\ e_1}{\epsilon}{\rho\ e_2}:[[Type]]$, which
      is equivalent to 
      $\Gamma' \tvdash{\theta} \rho\ (\arrowT{x}{\theta'}{e_1}{\epsilon}{e_2}):[[Type]]$.      
  \end{itemize}
  
  \begin{itemize}
  \item[Case.] \ \\
    \begin{center}
      \begin{math}
        $$\mprset{flushleft}
        \inferrule* [right=\FSdrulename{Var}]{
          \Gamma,\Gamma' \tvdash{\theta} e:[[Type]]
          \\\\
          x:^{\theta} e \in \Gamma,\Gamma'
        }{\Gamma,\Gamma' \tvdash{\theta} x:^{\theta} e}
      \end{math}
    \end{center}
    We have two cases to consider, either $x:^{\theta} e \in \Gamma$ or $x:^{\theta} e \in \Gamma'$.
    Suppose the former.
    By the induction hypothesis, $\Gamma' \tvdash{\theta} \rho\ e:[[Type]]$.  Since
    $x:^{\theta} e \in \Gamma$ there exists a mapping $(x \mapsto e') \in \rho$ such that 
    $e' \in \interp{e}^\theta_\rho$.  By the definition of the interpretation of types
    $\cdot \tvdash{\theta} e':\rho\ e$.  Now by weakening (Lemma~\ref{lemma:FS-weakening}) we know
    $\Gamma' \tvdash{\theta} e':\rho\ e$ which is equivalent to $\Gamma' \tvdash{\theta} \rho\ x:^{P} \rho\ e$.
    
    Now suppose the that $x:^{\theta} e \in \Gamma'$, then $\rho\,x = x$.  So by the induction
    hypothesis we know $\Gamma' \tvdash{\theta} \rho\ e:[[Type]]$, and by reapplying the
    $\FSdrulename{Var}$ rule we obtain $\Gamma' \tvdash{\theta} x:^{\theta} \rho\,e$ which is equivalent
    to $\Gamma' \tvdash{\theta} \rho\,x:^{\theta} \rho\,e$.
  \end{itemize}
\end{proof}

In order to prove that the \FSdrulename{Join} and \FSdrulename{Conv}
are logically consistent, we need to know that if a type is equivalent
to another, then their interpretations are equivalent.  It turns out
that instead of proving the equality directly we can prove a much
simpler result.  It suffices to show that if a type is equal to
another, then the interpretation of the first is subset of the
interpretation of the second.  Then using symmetry of the equality
proof we can obtain that they are in fact equal.  The following two
lemmas prove this for both the programmatic fragment and the logical
fragment respectfully:

\begin{lemma}[Computational Semantic Conversion]
  \label{lemma:pconv_in_interp_are_equiv}
  If $e \join e'$ and $\Gamma \tvdash{\theta'} e:B$ and 
  $\Gamma \tvdash{\theta''} e':C$ then 
  $\interp{[e/x]A}^P_\rho \subseteq \interp{[e'/x]A}^P_\rho$.
\end{lemma}
\begin{proof}
  We know that $a \in \interp{[e/x]A}^P_\rho$
  iff $\cdot \tvdash{P} a:\rho\ [e/x]A$ and $a\ is\ a\ value$ and $
  \cdot \tvdash{P} \rho\ [e/x]A:[[Type]]$ 
  by the definition of the interpretation of types.
  By $\FSdrulename{Join}$, $\Gamma \tvdash{L} join:e = e'$. Finally, by 
  $\FSdrulename{Conv}$, 
  $\cdot \tvdash{P} a:\rho\ [e'/x]A$.  Now by regularity $\cdot \tvdash{P} \rho\ [e'/x]A:[[Type]]$.
  Thus, $a \in \interp{[e'/x]A}^P_\rho$ and
  $\interp{[e/x]A}^P_\rho \subseteq \interp{[e'/x]A}^P_\rho$.
\end{proof}

\begin{lemma}[Logical Semantic Conversion]
  \label{lemma:lconv_in_interp_are_equiv}
  If $e \join e'$ and $\Gamma \tvdash{\theta'} e:B$ and $\Gamma \tvdash{\theta''} e':C$ then 
  $\interp{[e/x]A}^L_\rho \subseteq \interp{[e'/x]A}^L_\rho$.
\end{lemma}
\begin{proof}
  We proceed by induction on the form of $A$.  In each case we must show 
  $\cdot \tvdash{L} a:\rho[e'/x]A$ and $\cdot \tvdash{L} \rho[e'/x]A:[[Type]]$.  The former is easly 
  accomplished by first applying $\FSdrulename{Join}$ to obtain $\cdot \tvdash{L} join:e = e'$ 
  and then applying $\FSdrulename{Conv}$ to obtain the desired result.  The latter is obtained
  by regularity.
  
  \begin{itemize}
  \item[Case.] Let $A \equiv \nat$.  Obvious.
    
  \item[Case.] Let $A \equiv \arrowT{x}{\theta}{a_1}{+}{a_2}$, $\rho$ be an arbitrary 
    substitution and $a \in \interp{[e/x]A}^L_\rho$.  By the definition of the interpretations 
    of types,
    $a \in \interp{[e/x]A}^L_\rho$ iff for any 
    $a' \in \interp{[e/x]a_1}^\theta_\rho$ we have
    $a\ a' \in \interp{[e/x]a_2}^L_{\rho[x \mapsto a']}$.
    Let $a''$ be an arbitrary element of $\interp{[e/x]a_1}^\theta_\rho$. We have two cases
    to consider: when $\theta = L$ and $\theta = P$.  If $\theta = L$ then by the induction 
    hypothesis, 
    $\interp{[e/x]a_1}^L_\rho = \interp{[e'/x]a_1}^L_\rho$.  
    If $\theta = P$ then we apply  
    Lemma~\ref{lemma:pconv_in_interp_are_equiv} to obtain 
    $\interp{[e/x]a_1}^P_\rho = \interp{[e'/x]a_1}^P_\rho$.
    Also by the induction hypothesis,
    $\interp{[e/x]a_2}^L_{\rho[x \mapsto a'']} = \interp{[e'/x]a_2}^L_{\rho[x \mapsto a'']}$.  
    Thus, 
    $a'' \in \interp{[e'/x]a_1}^\theta_\rho$ and
    $a\ a'' \in \interp{[e'/x]a_2}^L_{\rho[x \mapsto a'']}$ for arbitrary $a''$, hence,
    by the definition of the interpretations of types,
    $a \in \interp{[e'/x]A}^L_\rho$.  Therefore, 
    $\interp{[e/x]A}^L_\rho \subseteq \interp{[e'/x]A}^L_\rho$.
    
  \item[Case.]  Let $A \equiv \arrowT{x}{\theta}{e_1}{-}{e_2}$.  Similar to the previous case.
    
  \item[Case.] Let $A \equiv a_1 = a_2$, $\rho$ be an arbitrary 
    substitution and $a \in \interp{[e/x]A}^L_\rho$.
    By the definition of the interpretations of types,
    $a \in \interp{[e/x]A}^L_\rho$ iff $a \in V$ and 
    $\rho[e/x]a_1 \join \rho[e/x]a_2$.
    Clearly, if $e \join e'$ and $\rho[e/x]a_1 \join \rho[e/x]a_2$ then 
    $\rho[e'/x]a_1 \join \rho[e'/x]a_2$.
    Thus, $a \in \interp{[e'/x]A}^L_\rho$.  Therefore,
    $\interp{[e/x]A}^L_\rho \subseteq \interp{[e'/x]A}^L_\rho$.
  \end{itemize}
\end{proof}
Finally, we have arrived at the main result, logical consistency.  The
following soundness result implies that any well-typed expression can
be closed using a series of well-typed expressions, and this closed
expression is joinable with a well-typed value.  Thus, all expressions
of the logical fragment terminate with a value, and we are free to
call these expressions and values proofs, and their types formulas.
\begin{thm}[Type soundness]
  \label{thm:type_soundness}
  If $\Gamma \tvdash{L} e:e'$ then for all 
  $\rho \in \interp{\Gamma}, \rho\ e \in \interp{e'}^L_\rho$.
\end{thm}
\begin{proof}
  Throughout this proof we implicitly assume an arbitrary $\rho \in \interp{\Gamma}$ and
  that $\cdot \tvdash{L} \rho\ e':[[Type]]$.  The latter holds by first applying regularity to obtain
  $\Gamma \tvdash{L} e:[[Type]]$ and then applying Lemma~\ref{lemma:substitution_kinding_typing} to
  obtain $\cdot \tvdash{L}\rho\ e:[[Type]]$.
  
  \begin{itemize}
  \item[]\ \\
    
  \item[]Case.\ \\
    \begin{center}
      \begin{math}
        $$\mprset{flushleft}
        \inferrule* [right=\FSdrulename{Var}]{
          \Gamma \tvdash{L} e:[[Type]]
          \\\\
          x:^{L} e \in \Gamma
        }{\Gamma \tvdash{L} x:^{L} e}
      \end{math}
    \end{center}
    By definition of $\interp{\Gamma}$ we know there exists some $e'$
    such that $(x,e') \in \rho$ and $e' \in \interp{e}^L_\rho$.
    Now $\rho\ x \equiv e' \in \interp{e}^L_\rho$.
    
  \item[]Case.\ \\
    \begin{center}
      \begin{math}
        $$\mprset{flushleft}
        \inferrule* [right=\FSdrulename{Lam}] {
          \Gamma \tvdash{\theta} e_1:[[Type]]
          \\\\
          \Gamma,x:^\theta e_1 \tvdash{L} e:e_2
        }{\Gamma \tvdash{L} \lambda x.e:\arrowT{x}{\theta}{e_1}{+}{e_2}}
      \end{math}
    \end{center}
    We need to show 
    $\rho\ \lambda x.e \equiv \lambda x.(\rho\ e) \in $
    $\interp{\arrowT{x}{\theta}{e_1}{+}{e_2}}^{L}_\rho$.  So by the
    definition of the interpretation of types, we must show for any
    $e' \in \interp{e_1}^\theta_\rho$, $(\lambda x.\rho\ e)\ e' \in
    \interp{e_2}^{L}_{\rho[x \mapsto e']}$.  Let $e' \in \interp{e_1}^\theta_\rho$. 
    By CR-Norm, $e'$ is closed and $e' \in V$, hence, $e' \normto v$ and
    by CR-Pres, $v \in \interp{e_1}^\theta_{\rho}$.  By the definition of the
    left-to-right CBV, $(\lambda x.(\rho\ e))\ e' \redto^* (\lambda x.(\rho\ e))\ v $
    $\redto \rho[v/x]\ e$.  We
    know $v \in \interp{e_1}^\theta_\rho$ and $\rho \in
    \interp{\Gamma}$, hence, by the definition of well-formed
    substitutions, $\rho[v/x] \in \interp{\Gamma,x:^\theta e_1}$.  We can now apply the
    induction hypothesis to obtain, $\rho[v/x]e \in
    \interp{e_2}^L_{\rho[x \mapsto v]}$. It is easy to see that $(\lambda
    x.(\rho\ e))\ e'$ is closed so we can apply CR-Pres and
    obtain $(\lambda x.(\rho\ e))\ e' \in
    \interp{e_2}^L_{\rho[x \mapsto v]}$.  By 
    Lemma~\ref{lemma:lconv_in_interp_are_equiv} and Lemma~\ref{lemma:movable_subs},
    $\interp{e_2}^L_{\rho[x \mapsto v]} = \interp{e_2}^L_{\rho[x \mapsto e']}$.
    Thus, by the definition of the
    interpretation of types, $\lambda x.(\rho\ e) \in
    \interp{\arrowT{x}{\theta}{e_1}{+}{e_2}}^{L}_\rho$.

  \item[]Case.\ \\
    \begin{center}
      \begin{math}
        $$\mprset{flushleft}
        \inferrule* [right=\FSdrulename{ILam}] {
          \Gamma \tvdash{\theta} e_1:[[Type]]
          \\\\
          \Gamma,x:^\theta e_1 \tvdash{L} v:e_2
          \\\\
          x \not \in fvs(v)
        }{\Gamma \tvdash{L} v:\arrowT{x}{\theta}{e_1}{-}{e_2}}
      \end{math}
    \end{center}
    We need to show 
    $\rho\ v \in \interp{\arrowT{x}{\theta}{e_1}{-}{e_2}}^{L}_\rho$.  So by the
    definition of the interpretation of types, we must show for any
    $e' \in \interp{e_1}^\theta_\rho$, $\rho\ v \in
    \interp{e_2}^{L}_{\rho[x \mapsto e']}$.  Let $e' \in
    \interp{e_1}^\theta_\rho$.  By CR-Norm, $e'$ is closed and $e' \in V$,
    hence, $e' \normto v'$ and by CR-Pres $v' \in \interp{e_1}^\theta_\rho$.
    By the definition of the left-to-right CBV, 
    $(\rho\ v)\ e' \redto^* (\rho\ v)\ v' \redto \rho[v'/x]\ v \equiv \rho\ v$.  We
    know $v' \in \interp{e_1}^\theta_\rho$ and $\rho \in
    \interp{\Gamma}$, hence, by the definition of well-formed
    substitutions, $\rho[v'/x] \in \interp{\Gamma,x:^\theta e_1}$.  Thus, 
    we can now apply the induction hypothesis to obtain, $\rho\ v \in
    \interp{e_2}^L_{\rho[x \mapsto v']}$. By 
    Lemma~\ref{lemma:lconv_in_interp_are_equiv} and Lemma~\ref{lemma:movable_subs} 
    $\interp{e_2}^L_{\rho[x \mapsto v']} = \interp{e_2}^L_{\rho[x \mapsto e']}$.  
    Thus, by the definition of the interpretation of types, $\rho\ v \in
    \interp{\arrowT{x}{\theta}{e_1}{-}{e_2}}^{L}_\rho$.

  \item[]Case.\ \\
    \begin{center}
      \begin{math}
        $$\mprset{flushleft}
        \inferrule*[right=\FSdrulename{AppPiTerm}]{
          \Gamma \tvdash{L} e:\arrowT{x}{\theta}{e_1}{+}{e_2}
          \\\\
          \Gamma \tvdash{\theta} v:e_1
        }{\Gamma \tvdash{L} e\ v:[v/x]e_2}
      \end{math}
    \end{center}


    By the induction hypothesis, $\rho\ e \in
    \interp{\arrowT{x}{\theta}{e_1}{+}{e_2}}^L_\rho$.  If $\theta = L$ then
    by the induction hypothesis, $\rho\ v \in \interp{e_1}^\theta_\rho$.  If $\theta = P$ then
    by Lemma~\ref{lemma:substitution_kinding_typing}, $\cdot \tvdash{P} \rho\ v:e_1$, and by the
    definition of the interpretation of types, $\rho\ v \in \interp{e_1}^\theta_\rho$.
    Now we know by the 
    definition of the
    interpretation of types that for any $v' \in
    \interp{e_1}^\theta_\rho$, $(\rho\ e)\ v' \in $
    $\interp{e_2}^L_{\rho[x \mapsto v']}$.  Instantiate $v'$ with $\rho\ v$. 
    Then $(\rho\ e)\ \rho\ v$ $\equiv \rho(e\ v) \in
    \interp{e_2}^L_{\rho[x \mapsto \rho\ v]}$.
    
  \item[]Case.\ \\
    \begin{center}
      \begin{math}
        $$\mprset{flushleft}
        \inferrule*[right=\FSdrulename{AppAllTerm}]{
          \Gamma \tvdash{L} e:\arrowT{x}{\theta}{e_1}{-}{e_2}
          \\\\
          \Gamma \tvdash{\theta} v:e_1
        }{\Gamma \tvdash{L} e:[v/y]e_2}
      \end{math}
    \end{center}

    By the induction hypothesis, $\rho\ e \in
    \interp{\arrowT{x}{\theta}{e_1}{-}{e_2}}^L_\rho$.  If $\theta = L$ then
    by the induction hypothesis, $\rho\ v \in \interp{e_1}^\theta_\rho$.  If
    $\theta = P$ then by Lemma~\ref{lemma:substitution_kinding_typing},
    $\cdot \tvdash{P} \rho\ v:\rho\ e_1$, thus, by the definition of the interpretation
    of types, $\rho\ v \in \interp{e_1}^\theta_\rho$.
    We know by the definition of the
    interpretation of types that for any $v' \in
    \interp{e_1}^\theta_\rho$, $\rho\ e \in $
    $\interp{e_2}^L_{\rho[x \mapsto v']}$.  Instantiate $v'$ with $\rho\ v$. 
    Then $\rho\ e \in \interp{e_2}^L_{\rho[x \mapsto \rho\ v]}$.
  
  \item[]Case.\ \\
    \begin{center}
      $\FSdrulejoin{}$
    \end{center}  
    It is a property of left-to-right CBV that
    if $e \join e'$ then $\rho\ e \join \rho\ e'$ for any substitution $\rho$.
    By Lemma~\ref{lemma:substitution_kinding_typing}, 
    $\cdot \tvdash{L} join : \rho\ e = \rho\ e'$.
    Hence by the definition of the interpretation of types, $join \in \interp{e = e'}^L_\rho$.

  \item[] Case.\ \\
    \begin{center}
      \begin{math}
        $$\mprset{flushleft}
        \inferrule* [right=\FSdrulename{InjDom}] {
          \Gamma \tvdash{L} e':(\arrowT{x}{\theta}{e_1}{+}{e_2}) = 
          (\arrowT{x}{\theta}{e'_1}{+}{e'_2})
        }{\Gamma \tvdash{L} injdom : e_1 = e'_1}
      \end{math}
    \end{center}
    By the induction hypothesis, 
    $e' \in \interp{(\arrowT{x}{\theta}{e_1}{+}{e_2}) = 
      (\arrowT{x}{\theta}{e'_1}{+}{e'_2})}^L_\rho$, which implies that 
    $\rho\ e_1 \join \rho\ e'_1$.  By Lemma~\ref{lemma:substitution_kinding_typing},
    $\cdot \tvdash{L} injdom : \rho\ e_1 = \rho\ e'_1$.  Therefore by the definition of the
    interpretation of types, $injdom \in \interp{e_1 = e'_1}^L_\rho$.

  \item[] Case.\ \\
    \begin{center}
      \begin{math}
        $$\mprset{flushleft}
        \inferrule* [right=\FSdrulename{InjRan}] {
          \Gamma \tvdash{L} e':(\arrowT{x}{\theta}{e_1}{+}{e_2}) = 
          (\arrowT{x}{\theta}{e'_1}{+}{e'_2})
          \\\\
          \Gamma \tvdash{\theta} v:e_1
        }{\Gamma \tvdash{L} injran : [v/x]e_2 = [v/x]e'_2}
      \end{math}
    \end{center}
    By the induction hypothesis, 
    $e' \in \interp{(\arrowT{x}{\theta}{e_1}{+}{e_2}) = 
      (\arrowT{x}{\theta}{e'_1}{+}{e'_2})}^L_\rho$, which implies that 
    $\rho\ e_2 \join \rho\ e'_2$.  Since compatibility joinablity is closed under substitution,
    $\rho\ [v/x]e_2 \join \rho\ [v/x]e'_2$, we can move $\rho$ to the outside, because $x$ is
    not a member of the domain of $\rho$. By Lemma~\ref{lemma:substitution_kinding_typing},
    $\cdot \tvdash{L} injran : \rho\ [v/x]e_2 = \rho\ [v/x]e'_2$.  Therefore by the definition of
    theinterpretation of types, $injran \in \interp{[v/x]e_2 = [v/x]e'_2}^L_\rho$.

  \item[]Case.\ \\
    \begin{center}
      \begin{math}
        $$\mprset{flushleft}
        \inferrule* [right=\FSdrulename{Conv}] {
          \Gamma \tvdash{L} e:[e_1/x]e_2
          \\\\
          \Gamma \tvdash{L} e':e_1 = e'_1
        }{\Gamma \tvdash{L} e:[e'_1/x]e_2}
      \end{math}

    \end{center}
    Applying the induction hypothesis to $\Gamma \tvdash{L} e':e_1 = e'_1$ implies 
    $\rho\,e_1 \join \rho\,e'_1$, and $\cdot \vdash^L \rho\,e_1 = \rho\,e'_1 : \mathsf{Type}$.  
    The latter implies that $\cdot \vdash^{[[th']]}  e_1 : A$ an $\cdot \vdash^{[[th']]}  e'_1 : A'$. 
    Now by the induction hypothesis, $e \in
    \interp{[e_1/x]e_2}^L_\rho$, and by  Lemma~\ref{lemma:lconv_in_interp_are_equiv},
    $\interp{[e_1/x]e_2}^L_\rho = \interp{[e'_1/x]e_2}^L_\rho$,
    thus, $e \in \interp{[e'_1/x]e_2}^L_\rho$.
  
  \item[]Case.\ \\
    \begin{center}
      $\FSdruleSucc{}$
    \end{center}
    Suppose $e \in \interp{\nat}^L_\rho$ then by CR-Norm $e$ is closed
    and $e \in N$, hence, $e \redto^* n$, where $n$ is a numeral.
    Clearly, $S\ n$ is closed and $S\ n \in N$, thus, $S\ n \in
    \interp{\nat}^L_{\rho[x \mapsto n]} = \interp{\nat}^L_\rho$.  
    Before we can apply CR-Prog we must show that $\cdot \tvdash{L} S\ e:\nat$.
    By the definition of the interpretation of types, $\cdot \tvdash{L} e:\nat$,
    and by assumption $\cdot \tvdash{L} S:\arrowT{x}{L}{\nat}{+}{e_2}$.  We can
    now apply $\FSdrulename{AppPiTerm}$ to obtain $\cdot \tvdash{L} S\ e:\nat$.
    Therefore, by CR-Prog, $S\ e \in \interp{\nat}^L_\rho$.
  
  \item[]Case.\ \\
    \begin{center}
      $\FSdruleZero{}$
    \end{center}
    Clearly, $Z$ is closed and $Z \in N$.  Thus, $Z \in
    \interp{\nat}^L_\rho$.

  \item[]Case.\ \\
    \begin{center}
      $\FSdruleContra{}$
    \end{center}
    By the induction hypothesis, $\rho\ e \in \interp{Z =
    S\ e'}^L_\rho$.  By the
    definition of the interpretation of types, $Z$ and $S\ e'$ are
    compatibly joinable, which is not the case, hence a
    contradiction.  Thus, we obtain that $contra \in
    \interp{e''}^L_\rho$ for any $e''$.
    
  \item[]Case.\ \\
    \begin{center}
      $\FSdruleContraAbort{}$
    \end{center}
    This case is similar to the previous case.

  \item[]Case.\ \\
    \begin{center}
      \begin{math}
        $$\mprset{flushleft}
        \inferrule* [right=\FSdrulename{ContraPiTh}] {
          \Gamma \tvdash{\theta''} e:[[Type]]
          \\\\
          \Gamma \tvdash{L} e':(\arrowT{x}{\theta}{e_1}{\epsilon}{e_2}) = 
          (\arrowT{x}{\theta'}{e'_1}{\epsilon'}{e'_2})
          \\\\
          \theta \neq \theta'
        }{\Gamma \tvdash{L} contra : e}
      \end{math}
    \end{center}
    The induction hypothesis allows us to conclude that $e'$ is a member of the 
    interpretation of its type which tells us that 
    $\rho\ (\arrowT{x}{\theta}{e_1}{\epsilon}{e_2}) \join 
    \rho\ (\arrowT{x}{\theta'}{e'_1}{\epsilon'}{e'_2}$, but this is a contradiction, because
    $\theta \neq \theta'$.  Therefore, $contra \in \interp{e}^L_\rho$.

  \item[]Case.\ \\
    \begin{center}
      \begin{math}
        $$\mprset{flushleft}
        \inferrule* [right=\FSdrulename{ContraPiEp}] {
          \Gamma \tvdash{\theta''} e:[[Type]]
          \\\\
          \Gamma \tvdash{L} e':(\arrowT{x}{\theta}{e_1}{\epsilon}{e_2}) = 
          (\arrowT{x}{\theta'}{e'_1}{\epsilon'}{e'_2})
          \\\\
          \epsilon \neq \epsilon'
        }{\Gamma \tvdash{L} contra : e}
      \end{math}
    \end{center}
    Similar to the previous case.
  
  \item[]Case.\ \\
    \begin{center}
      $\FSdruleRecNat{}$
    \end{center}
  
    We need to show that $\rho\ \rec{f}{x}{v} \equiv \rec{f}{x}{\rho\ v} \in $
    $\interp{\arrowT{x}{L}{\nat}{+}{e_2}}^L_\rho$.  By the
    definition of the interpretation of types, $\rec{f}{x}{\rho\ v}
    \in \interp{\arrowT{x}{L}{\nat}{+}{e_2}}^L_\rho$ iff for any $e
    \in \interp{\nat}^L_\rho$, we have $(\rec{f}{x}{\rho\ v})\ e
    \in \interp{e_2}^L_{\rho[x \mapsto e]}$, because $f \not \in FV(e_2)$.
    Let $e'$ be an arbitrary element of 
    $\interp{\nat}^L_\rho$.  By the definition of the interpretation of types,
    $e' \normto n \in N$, hence, $n \in V$ and by CR-Pres, $n \in
    \interp{\nat}^L_\rho$.  Thus, $(\rec{f}{x}{\rho\ v})\ e'
    \redto^* (\rec{f}{x}{\rho\ v})\ n \redto $
    $[n/x][\rec{f}{x}{\rho\ v}/f]\rho\ v$.  By the induction
    hypothesis, for any $\rho' \in $ $\interp{\Gamma,x:^L \nat,f:^L
    \arrowT{y}{L}{\nat}{+}{\arrowT{p}{L}{x = S\ y}{-}{[y/x]e_2}}}$,
    we have $\rho'\ v \in \interp{e_2}^L_{\rho'}$.

    \noindent
    At this point we need to show that
    $[n/x][\rec{f}{x}{\rho\ v}/f]\rho \in $ $\interp{\Gamma,x:^L
    \nat,f:^L \arrowT{y}{L}{\nat}{+}{\arrowT{p}{L}{x =
    S\ y}{-}{[y/x]e_2}}}$, but to conclude this we must have
    $\rec{f}{x}{\rho\ v} \in $
    $\interp{\arrowT{y}{L}{\nat}{+}{\arrowT{p}{L}{x =
    S\ y}{-}{[y/x]e_2}}}^L_{\rho[x \mapsto n]}$, which means
    we have to prove the following proposition.

  \noindent
  
  \begin{proposition}
    \label{prop:rec_interp_proof}
    For any $n \in \nat$, $\rec{f}{x}{\rho\ v} \in $
    $\interp{\arrowT{y}{L}{\nat}{+}{\arrowT{p}{L}{x=S\ y}{-}{[y/x]e_2}}}^L_{\rho[x \mapsto n]}$.
  \end{proposition}
  
  \noindent
  We proceed by induction on $n$.  For the base case let $n \equiv 0$.
  Then $\rec{f}{x}{\rho\ v} \in $
  $\interp{\arrowT{y}{L}{\nat}{+}{\arrowT{p}{L}{x =
  S\ y}{-}{[y/x]e_2}}}^L_{\rho[x \mapsto 0]}$ iff for any $e'
  \in \interp{\nat}^L_{\rho[x \mapsto 0]}$, we have
  $(\rec{f}{x}{\rho\ v})\ e' \in $ $\interp{\arrowT{p}{L}{x =
  S\ y}{-}{[y/x]e_2}}^L_{\rho[x \mapsto 0][y \mapsto e']}$.
  Let $e''$ be an arbitrary element of $\interp{\nat}^L_{\rho[x \mapsto 0]}$.  Then we know 
  $e'' \in \interp{\nat}^L_{\rho[x
  \mapsto 0]}$ and $e'' \normto n \in N$, hence, $n \in V$.  Now
  we have to show that $(\rec{f}{x}{\rho\ v})\ e'' \redto^*
  (\rec{f}{x}{\rho\ v})\ n\in $ $\interp{\arrowT{p}{L}{x =
  S\ y}{-}{[y/x]e_2}}^L_{\rho[x \mapsto 0][y \mapsto n]}$.  By
  the definition of the interpretation types we must show that for any
  $e''' \in \interp{x = S\ y}^L_{\rho[x \mapsto 0][y \mapsto n]}$, we
  have, $(\rec{f}{x}{\rho\ v})\ n \in $ $\interp{[y/x]e_2}_{\rho[x
  \mapsto 0][y \mapsto n][p \mapsto e''']}$.  Let 
  $a \in \interp{x = S\ y}^L_{\rho[x \mapsto 0][y \mapsto n]}$.
  By the definition of the interpretation, $a \join join$ and $0
  \join S\ n$, but this is a contradiction.

  \noindent
  Now let $n \equiv S\ n'$.  By the definition of the interpretation
  of types, $\rec{f}{x}{\rho\ v} \in
  \interp{\arrowT{y}{L}{\nat}{+}{\arrowT{p}{L}{x =
  S\ y}{-}{[y/x]e_2}}}^L_{\rho[x \mapsto n]}$ iff for any $a
  \in \interp{\nat}^L_{\rho[x \mapsto n]}$, we have
  $(\rec{f}{x}{\rho\ v})\ a \in \interp{\arrowT{p}{L}{x =
  S\ y}{-}{[y/x]e_2}}^L_{\rho[x \mapsto n][y \mapsto a]}$.  Let
  $a'$ be an arbitrary $a$. By CR-Norm and the definition of the
  interpretation of types, $a' \in N$, $a' \in V$, hence, $a' \normto
  v' \in \nat$.  By CR-Pres and the definition of the interpretation of
  types, $(\rec{f}{x}{\rho\ v})\ a' \redto^*
  (\rec{f}{x}{\rho\ v})\ v' \in \interp{\arrowT{p}{L}{x =
  S\ y}{-}{[y/x]e_2}}^L_{\rho[x \mapsto n][y \mapsto v']}$ iff
  for any $a'' \in \interp{x = S\ y}^L_{\rho[x \mapsto n][y \mapsto
  v']}$, we have $(\rec{f}{x}{\rho\ v})\ v' \in
  \interp{[y/x]e_2}^L_{\rho[x \mapsto n][y \mapsto v'][p \mapsto 
  a'']}$.  Let 
  $u \in \interp{x = S\ y}^L_{\rho[x \mapsto n][y \mapsto v']}$.  By the definition of the
  interpretation of types, $u \join join$ and $S\ n' \join S\ v'$,
  which implies $n' \join v'$.  Now $(\rec{f}{x}{\rho\ v})\ v'
  \redto [v'/x][\rec{f}{x}{\rho\ v}/f]\rho\ v$, so by CR-Pres it
  suffices to show, $[v'/x][\rec{f}{x}{\rho\ v}/f]\rho\ v \in
  \interp{[y/x]e_2}^L_{\rho[x \mapsto n][y \mapsto v'][p \mapsto
  u]}$.  It is easy to see that $x$ is not free in $[y/x]e_2$ and
  we know by assumption $p$ is also not free in $[y/x]e_2$, hence, 
  $\interp{[y/x]e_2}^L_{\rho[x \mapsto n][y \mapsto v'][p \mapsto u]} = 
  \interp{[y/x]e_2}^L_{\rho[y \mapsto v']}$, and by a simple renaming of variables,
  $\interp{[y/x]e_2}^L_{\rho[y \mapsto v']} =
  \interp{e_2}^L_{\rho[x \mapsto v']}$.  Thus, it suffices to show,
  $[v'/x][\rec{f}{x}{\rho\ v}/f]\rho\ v \in
  \interp{e_2}^L_{\rho[x \mapsto v']}$.  Finally, by 
  Lemma~\ref{lemma:movable_subs},
  it suffices to show, $[n'/x][\rec{f}{x}{\rho\ v}/f]\rho\ v \in
  \interp{e_2}^L_{\rho[x \mapsto n']}$, because $v' \join n'$.

  \noindent
  By the inner induction hypothesis, $\rec{f}{x}{\rho\ v} \in
  \interp{\arrowT{y}{L}{\nat}{+}{\arrowT{p}{L}{x =
  S\ y}{-}{[y/x]e_2}}}^L_{\rho[x \mapsto n']}$.
  Thus, $[n'/x][\rec{f}{x}{\rho\ v}/f]\rho \in
  \interp{\Gamma,x:^L \nat, f:^L
  \arrowT{y}{L}{\nat}{+}{\arrowT{p}{L}{x = S\ y}{-}{[y/x]e_2}}}$.
  We can now apply the outer induction hypothesis, where we substitute
  $v$ for $e$, $e_2$ for $e'$, $\Gamma,x:^L \nat,f:^L
  \arrowT{y}{L}{\nat}{+}{\arrowT{p}{L}{x = S\ y}{-}{[y/x]e_2}}$ for
  $\Gamma$, and $[n'/x][\rec{f}{x}{\rho\ v}/f]\rho$ for $\rho$,
  to obtain, $[n'/x][\rec{f}{x}{\rho\ v}/f]\rho\ v \in
  \interp{e_2}^L_{\rho[x \mapsto n'][f \mapsto
  \rec{f}{x}{\rho\ v}/f]} = \interp{e_2}^L_{\rho[x \mapsto
  n']}$, because $f \not \in FV(e_2)$.  This concludes the proof of the proposition.

  By Proposition~\ref{prop:rec_interp_proof}, $\rec{f}{x}{\rho\ v}
  \in $ $\interp{\arrowT{y}{L}{\nat}{+}{\arrowT{p}{L}{x =
  S\ y}{-}{[y/x]e_2}}}^L_{\rho[x \mapsto n]}$.  Thus,
  $[n/x][\rec{f}{x}{\rho\ v}/f]\rho \in $ $\interp{\Gamma,x:^L
  \nat,f:^L \arrowT{y}{L}{\nat}{+}{\arrowT{p}{L}{x =
  S\ y}{-}{[y/x]e_2}}}$ and we can finally conclude,
  $[n/x][\rec{f}{x}{\rho\ v}/f]\rho\ v \in $
  $\interp{e_2}^L_{\rho[x \mapsto n]}$.  By
  CR-Pres, $(\rec{f}{x}{\rho\ v})\ e \in $ $\interp{e_2}^L_{\rho[x \mapsto n]}$.  
  Therefore, $\rec{f}{x}{\rho\ v} \in \interp{\arrowT{x}{L}{\nat}{+}{e_2}}^L_\rho$.

\item[]Case.\ \\
  \begin{center}
    $\FSdruleRecNatComp{}$
  \end{center}
  We must show, for any $a \in \interp{\nat}^L_{\rho}$, we have $\recc{f}{x}{\rho\ v} \in
  \interp{e_2}^L_{\rho[x \mapsto a]}$.  Let $a'$ be an arbitrary $a$.  Then by CR-Norm and the 
  interpretation of types, $a' \in N$, $a' \in V$
  and $a \normto n \in \nat$.  So $(\recc{f}{x}{\rho\ v})\ a \redto^* 
  (\recc{f}{x}{\rho\ v})\ n \redto [n/x][\recc{f}{x}{\rho\ v}/f]\rho\ v \equiv
  [\recc{f}{x}{\rho\ v}/f]\rho\ v$.  By CR-Pres it suffices to show, 
  $[\recc{f}{x}{\rho\ v}/f]\rho\ v \in \interp{e_2}^L_{\rho[x \mapsto n]}$.  To conclude this
  we have to show $[\recc{f}{x}{\rho\ v}/f]\rho \in \interp{\Gamma,x:^L \nat, f:^L 
  \arrowT{y}{L}{\nat}{-}{\arrowT{p}{L}{x = S\ y}{-}{[y/x]e_2}}}$.  This requires us to prove the 
  following proposition.

  \noindent
  
  \begin{proposition}
    \label{prop:recc_interp_proof}
    For any $n \in \nat$, $\recc{f}{x}{\rho\ v} \in $
    $\interp{\arrowT{y}{L}{\nat}{-}{\arrowT{p}{L}{x=S\ y}{-}{[y/x]e_2}}}^L_{\rho[x \mapsto n]}$.
  \end{proposition}
  
  \noindent
  We proceed by induction on $n$.  For the base case let $n \equiv 0$.
  Then $\recc{f}{x}{\rho\ v} \in $
  $\interp{\arrowT{y}{L}{\nat}{-}{\arrowT{p}{L}{x =
  S\ y}{-}{[y/x]e_2}}}^L_{\rho[x \mapsto 0]}$ iff for any $e'
  \in \interp{\nat}^L_{\rho[x \mapsto 0]}$, we have
  $\recc{f}{x}{\rho\ v} \in $ $\interp{\arrowT{p}{L}{x =
  S\ y}{-}{[y/x]e_2}}^L_{\rho[x \mapsto 0][y \mapsto e']}$.
  Let 
  $e'' \in \interp{\nat}^L_{\rho[x \mapsto 0]}$. Then, we know, 
  $e'' \normto n' \in N$, hence, $n' \in V$.  
  Now we have to show that $(\recc{f}{x}{\rho\ v})\ e'' \redto^*
  (\recc{f}{x}{\rho\ v})\ n' \equiv \recc{f}{x}{\rho\ v}
  \in $ $\interp{\arrowT{p}{L}{x =
  S\ y}{-}{[y/x]e_2}}^L_{\rho[x \mapsto 0][y \mapsto n']}$.  By
  the definition of the interpretation types we must show that for any
  $e''' \in \interp{x = S\ y}^L_{\rho[x \mapsto 0][y \mapsto n']}$ we
  have $\recc{f}{x}{\rho\ v} \in $ $\interp{[y/x]e_2}_{\rho[x
  \mapsto 0][y \mapsto n'][p \mapsto e''']}$.  Let 
  $a \in \interp{x = S\ y}^L_{\rho[x \mapsto 0][y \mapsto n']}$.  
  Then by the definition of the interpretation, $a \join join$ and $0
  \join S\ n$, but this is a contradiction.

  \noindent
  Now let $n \equiv S\ n'$.  By the definition of the interpretation
  of types, $\recc{f}{x}{\rho\ v} \in
  \interp{\arrowT{y}{L}{\nat}{-}{\arrowT{p}{L}{x =
  S\ y}{-}{[y/x]e_2}}}^L_{\rho[x \mapsto n]}$ iff for any $a
  \in \interp{\nat}^L_{\rho[x \mapsto n]}$, we have
  $\recc{f}{x}{\rho\ v} \in \interp{\arrowT{p}{L}{x =
  S\ y}{-}{[y/x]e_2}}^L_{\rho[x \mapsto n][y \mapsto a]}$.  Let
  $a'$ be an arbitrary $a$. Then by CR-Norm and the definition of the
  interpretation of types, $a' \in N$, $a' \in V$, hence, $a' \normto
  v' \in \nat$.  By CR-Pres and the definition of the interpretation of
  types, $(\recc{f}{x}{\rho\ v})\ a' \redto^*
  (\recc{f}{x}{\rho\ v})\ v' \equiv \recc{f}{x}{\rho\ v} \in 
  \interp{\arrowT{p}{L}{x = S\ y}{-}{[y/x]e_2}}^L_{\rho[x \mapsto n][y \mapsto v']}$ iff
  for any $a'' \in \interp{x = S\ y}^L_{\rho[x \mapsto n][y \mapsto v']}$, we have 
  $\recc{f}{x}{\rho\ v} \in
  \interp{[y/x]e_2}^L_{\rho[x \mapsto n][y \mapsto v'][p \mapsto 
  a'']}$. Suppose $u \in \interp{x = S\ y}^L_{\rho[x \mapsto n][y \mapsto v']}$.  
  By the definition of the
  interpretation of types, $u \join join$ and $S\ n' \join S\ v'$,
  which implies, $n' \join v'$.  Now $(\recc{f}{x}{\rho\ v})\ v'
  \redto [v'/x][\recc{f}{x}{\rho\ v}/f]\rho\ v \equiv 
  [\recc{f}{x}{\rho\ v}/f]\rho\ v$, so by CR-Pres it
  suffices to show, $[\recc{f}{x}{\rho\ v}/f]\rho\ v \in
  \interp{[y/x]e_2}^L_{\rho[x \mapsto n][y \mapsto v'][p \mapsto
  u]}$.  It is easy to see that $x$ is not free in $[y/x]e_2$ and
  we know $p$ is also not free
  in $[y/x]e_2$, hence, $\interp{[y/x]e_2}^L_{\rho[x \mapsto n][y
  \mapsto v'][p \mapsto u]} = \interp{[y/x]e_2}^L_{\rho[y
  \mapsto v']}$, and by a simple renaming of variables,
  $\interp{[y/x]e_2}^L_{\rho[y \mapsto v']} =
  \interp{e_2}^L_{\rho[x \mapsto v']}$.  Thus, it suffices to show,
  $[\recc{f}{x}{\rho\ v}/f]\rho\ v \in
  \interp{e_2}^L_{\rho[x \mapsto v']}$.  Finally, by  
  Lemma~\ref{lemma:movable_subs},
  it suffices to show, $[\recc{f}{x}{\rho\ v}/f]\rho\ v \in
  \interp{e_2}^L_{\rho[x \mapsto n']}$, because $v' \join n'$.

  \noindent
  By the inner induction hypothesis, $\recc{f}{x}{\rho\ v} \in
  \interp{\arrowT{y}{L}{\nat}{-}{\arrowT{p}{L}{x =
  S\ y}{-}{[y/x]e_2}}}^L_{\rho[x \mapsto n']}$.
  Thus, $[\recc{f}{x}{\rho\ v}/f]\rho \in
  \interp{\Gamma,x:^L \nat, f:^L
  \arrowT{y}{L}{\nat}{-}{\arrowT{p}{L}{x = S\ y}{-}{[y/x]e_2}}}$.
  We can now apply the outer induction hypothesis, where we substitute
  $v$ for $e$, $e_2$ for $e'$, $\Gamma,x:^L \nat,f:^L
  \arrowT{y}{L}{\nat}{-}{\arrowT{p}{L}{x = S\ y}{-}{[y/x]e_2}}$ for
  $\Gamma$, and $[\recc{f}{x}{\rho\ v}/f]\rho$ for $\rho$,
  to obtain, $[\recc{f}{x}{\rho\ v}/f]\rho\ v \in
  \interp{e_2}^L_{\rho[x \mapsto n'][f \mapsto
  \recc{f}{x}{\rho\ v}/f]} = \interp{e_2}^L_{\rho[x \mapsto
  n']}$, because $f \not \in FV(e_2)$.  This concludes the proof of the proposition.

  By Proposition~\ref{prop:rec_interp_proof}, $\recc{f}{x}{\rho\ v}
  \in $ $\interp{\arrowT{y}{L}{\nat}{-}{\arrowT{p}{L}{x =
  S\ y}{-}{[y/x]e_2}}}^L_{\rho[x \mapsto n]}$.  Thus,
  $[\recc{f}{x}{\rho\ v}/f]\rho \in $ $\interp{\Gamma,x:^L
  \nat,f:^L \arrowT{y}{L}{\nat}{-}{\arrowT{p}{L}{x =
  S\ y}{-}{[y/x]e_2}}}$ and we can finally conclude,
  $[\recc{f}{x}{\rho\ v}/f]\rho\ v \in $
  $\interp{e_2}^L_{\rho[x \mapsto n]}$.  By
  CR-Pres, $\recc{f}{x}{\rho\ v} \in $ $\interp{e_2}^L_{\rho[x \mapsto n]}$.  Therefore,
  $\recc{f}{x}{\rho\ v} \in $
  $\interp{\arrowT{x}{L}{\nat}{-}{e_2}}^L_\rho$.
\end{itemize}
\end{proof}
% section logical_consistency (end)

%%% Local Variables: ***
%%% mode: latex ***
%%% TeX-master: "thesis.tex" ***
%%% End: ***